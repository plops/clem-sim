\documentclass[11pt,abstracton,titlepage]{scrartcl}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{units}
\usepackage{amsmath}
\usepackage{verbatim}
\usepackage{listings}
\usepackage{color}
\usepackage{textcomp}
\usepackage{subfigure}
\usepackage{refcheck} % for draft

\definecolor{listinggray}{gray}{0.9}
\definecolor{lbcolor}{rgb}{0.9,0.9,0.9}
\lstset{
	backgroundcolor=\color{lbcolor},
	tabsize=4,
	rulecolor=,
	language=matlab,
        basicstyle=\scriptsize,
        upquote=true,
        aboveskip={1.5\baselineskip},
        columns=fixed,
        showstringspaces=false,
        extendedchars=true,
        breaklines=true,
        prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
        frame=single,
        showtabs=false,
        showspaces=false,
        showstringspaces=false,
        identifierstyle=\ttfamily,
        keywordstyle=\color[rgb]{0,0,1},
        commentstyle=\color[rgb]{0.133,0.545,0.133},
        stringstyle=\color[rgb]{0.627,0.126,0.1},
}

\newcommand{\abs}[1]{\left| #1 \right|}
\newcommand{\avg}[1]{\langle #1 \rangle}
\newcommand{\figref}[1]{Figure~\ref{#1}}
\renewcommand{\v }[1]{\bf #1}
\title{CLEM PAM}
\author{Martin Kielhorn}

\begin{document}
\section{On the numerical test sample}


As a test object I create a sphere shell, a line and a rectangle.
That is shown in the following code.  The objective is a NA1.4 oil
with coherent \unit[473]{nm} excitation light and detection is at
\unit[520]{nm} (incoherent).

The following listing shows how the image of the grating for
non-uniform excitation is calculated. The z-section of the result is
shown in \figref{fig:grating}. The illumination source is coherent
therefore the grating structure is visible over quite a large
z-distance (due to the reimaging by the Talbot effect).


\begin{lstlisting}
n=128;
nmperpixel=100;
sz=2;
znmperpixel=sz*nmperpixel;
%% vector psf for excitation illumination
asf=squeeze(kSimPSF({'lambdaEx',473;'na',NA;'ri',1.518;...
    'sX',n;'sY',n;'sZ',sz*n;...
    'scaleX',nmperpixel;'scaleY',nmperpixel;'scaleZ',znmperpixel;...
    'computeASF',1}));


%% grating of period P
% one pixel is 100nm so the period is P*100nm
P=6;
grat2d=(mod(xx(n,n),P)>(floor(P/2)-1))*1000;
%% fill a 3d grating
grat=newim(n,n,sz*n);
grat(:,:,(sz*n)/2)=grat2d(:,:);
kgrat=ft(grat);

%% coherent imaging
imgratx=ift(kgrat.*ft(squeeze(asf(:,:,:,0))));
imgraty=ift(kgrat.*ft(squeeze(asf(:,:,:,1))));
imgratz=ift(kgrat.*ft(squeeze(asf(:,:,:,2))));
imgrat=abs(imgratx).^2+abs(imgraty).^2+abs(imgratz).^2
\end{lstlisting}

\begin{figure}[htb]
  \centering
  \includegraphics{grating_xz}

  \caption{x-z-Section {\tt imgrat(:,64,:)} of the coherent
    image of the grating in object space.}
  \label{fig:grating}
\end{figure}

The following listing shows how the sample object (i.e. fluorophore
concentration) is generated.  It consists of a spherical shell
(calculated by the product of two Sinc functions in k-space and a
product with $r$ in real space). There is also a vertical line and a
rectangle. A slice through the simulated fluorophore concentration is
shown \figref{fig:input} left.

The shift by {\tt dz} in z-direction is done by multiplication with
$\exp(-ik{\tt dz})$ in k-space. This is only a good method to defocus
small distances {\tt dz} as the object will wrap around the borders.

\begin{lstlisting}
%% as an object I want a hollow sphere
% I define it in k-space
kobj=sinc(rr(kpsf)./2).*sinc(rr(kpsf)./0.7);

% this is the sphere
obj=rr(psf).*abs(ift(kobj));
maximum=max(obj);
% in-focus rectangle in right top
obj(83:114,23:43,(sz*n)/2)=4*maximum;
% in-focus line on the left
obj(21:21,40:90,(sz*n)/2)=12*maximum;

%% shift the object a little bit in z
kobj=ft(obj);
dz=1; % shift in pixels -> 1 equals 100nm
kobj=kobj.*exp(-i*2*pi*zz(kobj,'freq')*dz);
obj=ift(kobj);
\end{lstlisting}

In order to simulate the final image the fluorophore concentration is
multiplied by the excitation field and the result is convolved with
the PSF of the microobjective (this time according to the rules of
incoherent imaging). The Matlab code for this is shown in the
following listing:
\begin{lstlisting}
%% for imaging the fluorescence light
psf=kSimPSF({'lambdaEx',473;'lambdaEm',520;'na',1.4;'ri',1.518;...
        'sX',n;'sY',n;'sZ',sz*n;...
        'scaleX',nmperpixel;'scaleY',nmperpixel;'scaleZ',znmperpixel});
%% ft thereof
kpsf=ft(psf);
%% excited fluorophores
fluo=obj.*imgrat;

%% fluorescence image with structured illumination
strucflimg=ift(ft(fluo).*kpsf);

%% widefield fluorescence image
flimg=ift(ft(obj).*kpsf);

%% extract focal planes
iu=real(squeeze(flimg(:,:,(sz*n)/2)));     % uniform illumination
in=real(squeeze(strucflimg(:,:,(sz*n)/2)));% structured illumination
\end{lstlisting}


The image for uniform illumination is shown in
the middle of \figref{fig:input}. The right picture shows the image
for non-uniform illumination with the \unit[600]{nm}-period grid.

\begin{figure}[htb]
  \centering
  \subfigure[object]{\includegraphics[width=4cm]{obj}}
  \subfigure[widefield illumination]{\includegraphics[width=4cm]{iu}}
  \subfigure[structured illumination]{\includegraphics[width=4cm]{in}}
  \caption{Slice of the object in the focal plane. It consists of a
    line, a spherical shell and a rectangle. Only the shell is
    extended in z. {\bf(a)}, Image with widefield
    illumination. {\bf(b)}, Image with structured illumination
    (grating period \unit[600]{nm}). {\bf(c)} The scalebar is
    \unit[2]{$\mu$m} wide. }
  \label{fig:input}
\end{figure}

\figref{fig:defocus} shows the non-uniformly illuminated images for
the object being moved relative to the plane of focus. The line and
the rectangle are both blurred and the contrast of the grating
decreases.
\begin{figure}[htb]
  \centering
  \subfigure[100 nm defocus]{\includegraphics[width=4cm]{in100}}
  \subfigure[200 nm]{\includegraphics[width=4cm]{in200}}
  \subfigure[500 nm]{\includegraphics[width=4cm]{in500}}
  \caption{Defocus series of the test object under structured coherent
    illumination (grating period \unit[600]{nm}). The scalebar is
    \unit[2]{$\mu$m} wide.}
  \label{fig:defocus}
\end{figure}


\section{State of the Art}
If a fluorescent plane is imaged with a fluorescence widefield
microscope, the intensity of the image is constant no matter if the
plane is in-focus or not. 
\subsection{Apotome}
Using non-uniform excitation light the Wilson group was able to
circumvent this problem (\cite{1997Neil}). They project a grid pattern
into the sample. For a fluorescent plane sample the modulation in the
image is highest, when the sample is in-focus. If the plane is moved
out of focus, the modulation decreases. Hence it is possible to achieve
z-sectioning in a widefield microscope.

For one section $I_p$ they combine three grating images $I_i$ (grating
period $1/\nu$) with different phases:
\begin{align}
  I_p=\abs{I_1+I_2e^{i2\pi/3}+I_3e^{i4\pi/3}}
  \sim\abs{ 2 \frac{J_1(2u\nu(1-\nu/2))}{u\nu(1-\nu/2)}}.
\end{align}

The last term is their result for the intensity of a fluorescent plane
with the defocus $u$. If no grating is displayed ($\nu=0$) the
resulting image $I_p$ is constant and the microscope has no sectioning
capability. A fine grating gives best sectioning capability (but one
has to make a tradeoff as a fine grating will give very low contrast
in a thick specimen).

For this method is necessary to capture three images to generate one
sectioned slice. This can be a problem if the movement of the grating
isn't perfect or if the object moves during these exposures.

\subsection{HiLo}
This problem is addressed by Jerome Mertz et al.\ (\cite{2008Lim},
\cite{2009Santos}). They discovered that only two images need to be
captured for each z-sectioned slice.
An image with uniform illumination contains contributions
of both in-focus and out-of-focus fluorophores:
\begin{align}
  I_u(x,y)=I_\textrm{in}(x,y)+I_\textrm{out}(x,y).
\end{align}
Due to the structure of the OTF out-of-focus light is limited to low
spatial frequencies.

The modulated part of the non-uniformly illuminated image contains only
information of the in-focus object structure:
\begin{align}
  I_n(x,y)&=I_\textrm{in}(x,y)(1+M
  \sin(\kappa x+\varphi))+I_\textrm{out}(x,y),\\
  \kappa&=\frac{2\pi}{\lambda}n\sin(\alpha)\nu.
\end{align}

The sectioned image is a combination of high-frequency components of
the widefield image $I_u$ and the low-frequency components of the
modulated part of the non-uniform image $I_n$.


\subsubsection{Speckle}
In the older publication (\cite{2008Lim}) a random speckle pattern is
projected into the sample (presumably because this is experimentally
easier than projecting a grating). For completeness I describe my
reimplementation of their method. 

In order to process the non-uniform image it is divided into
subregions.  As a measure of local contrast in each of these
subregions the relative standard deviation is calculated 
(the operator $\avg{\cdot}$ indicates averaging):
\begin{align}
  c_n=\frac{\sqrt{\avg{I_n^2}-\avg{I_n}^2}}{\avg{I_n}}.
\end{align}
The relative standard deviation $c_n$ will be zero for image regions
without in-focus contributions. Its value increases as the modulation
of the non-uniform illumination increases (that's what we
want). However $c_n$ also increases if there is a small in-focus
feature. In that we are not interested as we only want to build up an
image of in-focus fluorophores with low spatial frequencies. To
correct for that we refer to the most complicated part of the paper
(in my opinion) -- its equation (4). I will repeat their argument
here.

Let $O$ be the image intensity obtained with perfectly uniform
illumination and $S$ the image intensity for the non-uniform
illumination a uniform object. Then the uniformly illuminated image of
the object is:
%FIXME Obviously I still don't understand it!
\begin{align}
  I_u\approx (\avg{O}+\delta O)\avg{S}.
\end{align}
Here the change of $I_u$ due to some object variations $\delta O$ can
only come from in-focus contributions.

\begin{align}
\label{in}
  I_n\approx (\avg{O}+\delta O)(\avg{S}+\delta S).
\end{align}
Here too, $\delta O$ and $\delta S$ come from the focus plane.

The authors state that a corrected relative standard deviation
of the non-uniform illumination can be calculated like this:
\begin{align} 
  c_s^2=\frac{c_n^2-c_0^2}{1+c_0^2}
  =
  \frac{\avg{I_n^2}}{\avg{I_n}^2}
  \frac{\avg{I_u^2}}{\avg{I_u}^2}-1.
\end{align}
Where $c_0$ is the relative standard deviation of the widefield image
$I_u$. The product $I_{su}=c_s\avg{I_u}$ then provides a low
resolution version of $I_u$ that is optically sectioned even for dc
frequencies.

The following listing shows how this algorithm can be applied to two
square input images {\tt iu} and {\tt in}. Instead of doing a discrete
integration over regions I multiply with a gaussian in Fourier
space. The cutoff frequency $k_c$ of the filter is chosen low enough
so that $c_s$ doesn't contain any structure of the grating anymore.
\begin{lstlisting}
si=size(in);
n=si(1);
kc=0.04;
r=rr(in,'freq');
klp=exp(-r.^2/(2*kc^2));
khp=1-klp;
ina=ift(ft(in).*klp);
in2a=ift(ft(in.^2).*klp);
iua=ift(ft(iu).*klp);
iu2a=ift(ft(iu.^2).*klp);
cs2=in2a.*iua.^2./(ina.^2.*iu2a)-1;
isu=sqrt(cs2).*iua;
kihp=ft(iu).*khp;
kilp=ft(isu).*klp;
\end{lstlisting}

\begin{figure}[htb]
  \centering
  \subfigure[Corrected relative standard deviation $c_s$.]{\includegraphics[width=4cm]{cs}}
  \subfigure[The product $I_{su}=c_sI_u$]{\includegraphics[width=4cm]{isu}}
  \subfigure[Low spatial frequency section $I_\textrm{lp}$]{\includegraphics[width=4cm]{ilp}}
  \caption{Several intermediate results of the algorithm. The scalebar is
    \unit[2]{$\mu$m} wide.}
  \label{fig:hilo1interm}
\end{figure}


The HiLo method combines a low-pass filtered version of $I_{su}$ with
a high pass filtered version of the uniformly illuminated image $I_u$.
To do this the two images are scaled for a seamless interface along
the circle $K$ with radius $\abs{\v k_c}$ in k-space and then added:
\begin{align}
  \eta=\!\!\!\!\ointop_{\partial K_{k_c}}\!\!\!
  \frac{\abs{I_\textrm{hp}}}{\abs{I_\textrm{lp}}}\,\textrm{d}\v k,\\
  I_\textrm{hilo}=\eta I_\textrm{lp}+I_\textrm{hp}.
\end{align}

This is done in the following listing:
\begin{lstlisting}
ring=real(ft(besselj(0,2*pi*kc*n.*r)));
ring2=r-1./n<kc & r+1./n>kc;
cring=ring.*ring2;
nring=cring./sum(cring); % normalized ring with radius kc
eta=sum(abs(kihp)./abs(kilp).*nring);
ihilo=ift(eta.*kilp+kihp);
\end{lstlisting}

\begin{figure}[htb]
  \centering
  \subfigure[High frequency components $I_\textrm{hp}$ of widefield.]{\includegraphics[width=4cm]{ihp}}
  \subfigure[Combined images $\hat I_\textrm{hilo}$ in k-space.]{\includegraphics[width=4cm]{kihilo}}
  \subfigure[Combined section $I_\textrm{hilo}$.]{\includegraphics[width=4cm]{ihilo}}
  \caption{Further intermediate and the end result of the HiLo ``speckle'' algorithm. The white circle in image {\bf (b)} marks $k_c$. The scalebars are \unit[2]{$\mu$m} wide.}
  \label{fig:hilo1interm2}
\end{figure}

\subsubsection*{Discussion}
This algorithm only requires that the illumination intensity in $I_n$
fluctuates over a certain region. Probably one gets better results
when the exact illumination pattern is known and taken into account.

\subsubsection{Grating}
This is done in the next paper. 

\section{Our Method}



\bibliographystyle{plain}
\bibliography{clempam}
\end{document}
